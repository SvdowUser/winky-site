<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winky – Token tracker</title>

  <style>
    :root {
      --bg: #050608;
      --card: #0b0f14;
      --accent: #00fff7;
      --accent-soft: rgba(0,255,247,0.12);
      --accent-strong: rgba(0,255,247,0.25);
      --text-main: #f7f7f7;
      --text-muted: #a3abb8;
      --danger: #ff4d72;
      --green: #7cff4d;
    }

    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      background: radial-gradient(circle at top, #07121c 0, var(--bg) 55%);
      color: var(--text-main);
    }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* NAVBAR */
    .nav {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 20px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-dots {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent-soft);
    }

    .nav-brand {
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .nav-links a {
      margin-left: 18px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .nav-links a:hover { color: var(--accent); }
    .nav-links a.active { color: var(--accent); }

    /* PAGE WRAPPER */
    .page {
      max-width: 980px;
      margin: 0 auto 80px;
      padding: 0 20px 80px;
    }

    section { margin-top: 32px; }

    .section-label {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.16em;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 26px;
      margin: 0 0 10px;
    }

    .section-text {
      margin: 0 0 20px;
      color: var(--text-muted);
      font-size: 15px;
      max-width: 640px;
    }

    /* FILTERBAR */
    .filter-bar {
      margin-top: 18px;
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      flex: 1 1 260px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(5,7,11,0.9);
      color: var(--text-main);
      padding: 9px 14px;
      font-size: 13px;
      outline: none;
    }

    .search-input::placeholder {
      color: rgba(255,255,255,0.35);
    }

    .select-pill {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(5,7,11,0.9);
      color: var(--text-main);
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
    }

    .checkbox-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px dashed rgba(255,255,255,0.18);
      background: rgba(2,6,12,0.7);
    }

    .checkbox-pill input { accent-color: var(--accent); }

    /* TABLE */
.table-wrapper {
  margin-top: 8px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.10);
  overflow: hidden;
  background: radial-gradient(circle at top left,
    rgba(0,255,247,0.08), var(--card));
  padding-right: 8px;   /* NEU: Platz rechts im Wrapper */
}


    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead { background: rgba(0,0,0,0.45); }

    th, td {
      padding: 10px 14px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    /* etwas extra Platz für die Buttons in der letzten Spalte */
    th:last-child,
    td:last-child {
      padding-right: 32px;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      white-space: nowrap;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }

    .token-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .token-logo {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #111622;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      overflow: hidden;
      flex-shrink: 0;
    }

    .token-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .token-name {
      font-weight: 500;
      font-size: 13px;
    }

    .token-symbol {
      font-size: 11px;
      color: var(--text-muted);
    }

    .number-cell { white-space: nowrap; }

    .risk-badge {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 11px;
      text-transform: capitalize;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
    }

    .change-badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 64px;
    }

    .change-pos {
      color: #7cff4d;
      background: rgba(124,255,77,0.10);
    }

    .change-neg {
      color: #ff4d72;
      background: rgba(255,77,114,0.12);
    }

    .change-flat {
      color: var(--text-muted);
      background: rgba(255,255,255,0.04);
    }

    .risk-safe   { border-color: rgba(124,255,77,0.6);   color: var(--green); }
    .risk-medium { border-color: rgba(255,184,77,0.7);   color: #ffd27f; }
    .risk-high   { border-color: rgba(255,77,114,0.8);   color: var(--danger); }

    .from-winky-pill {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,255,247,0.45);
      color: var(--accent);
      background: rgba(0,255,247,0.06);
    }

    .btn-xs {
      font-size: 11px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.6);
      color: var(--text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      margin-right: 2px;
    }

    .btn-xs:hover { background: rgba(255,255,255,0.06); }

    .table-message-row td {
      padding: 18px 14px;
      text-align: center;
      font-size: 13px;
      color: var(--text-muted);
    }

    .table-footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 768px) {
      .nav { padding-inline: 14px; }
      .page { padding-inline: 14px; }
      .filter-bar { flex-direction: column; align-items: stretch; }
      th:nth-child(3), td:nth-child(3),
      th:nth-child(4), td:nth-child(4),
      th:nth-child(5), td:nth-child(5) {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- NAV -->
  <header class="nav">
    <div class="nav-left">
      <div class="nav-dots">
        <span class="nav-dot"></span>
        <span class="nav-dot"></span>
      </div>
      <span class="nav-brand">Winky</span>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="tracker.html" class="active">Token tracker</a>
    </nav>
  </header>

  <!-- PAGE CONTENT -->
  <main class="page">
    <section>
      <div class="section-label">Explorer</div>
      <h1 class="section-title">Token tracker &amp; risk radar</h1>
      <p class="section-text">
        Live trending <strong>Solana</strong> tokens via the Birdeye API (proxied by your Cloudflare Worker).
        Sorted by a simple risk hint (safe → medium → high) and their trending rank.
      </p>

      <!-- FILTERBAR -->
      <div class="filter-bar">
        <input
          id="search"
          class="search-input"
          type="text"
          placeholder="Search by name or ticker…"
        />

        <select id="filter-risk" class="select-pill">
          <option value="all" selected>Risk: safe first (all)</option>
          <option value="safe">Only safe</option>
          <option value="medium">Only medium</option>
          <option value="high">Only high</option>
        </select>

        <select id="filter-mcap" class="select-pill">
          <option value="all" selected>Market cap: all</option>
          <option value="small">&lt; 1M</option>
          <option value="mid">1M – 10M</option>
          <option value="large">&gt; 10M</option>
        </select>

        <label class="checkbox-pill" title="Becomes active once Winky can launch real tokens">
          <input id="filter-winky" type="checkbox" disabled />
          Only Winky launches (soon)
        </label>
      </div>

      <!-- TABLE -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Token</th>
              <th>Chain</th>
              <th>Price</th>
              <th>24h change</th>
              <th>Market cap</th>
              <th>24h volume</th>
              <th>Risk</th>
              <th>From Winky</th>
              <th></th>
            </tr>
          </thead>

          <tbody id="token-rows">
            <tr class="table-message-row">
              <td colspan="9">Loading live data from Birdeye…</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- LOAD MORE -->
      <div style="margin-top: 12px; text-align: center;">
        <button id="load-more-btn" class="btn-xs">
          Load more tokens
        </button>
      </div>

      <p class="table-footer-note">
        Risk tags are rough UX hints based on liquidity &amp; volume – not a real audit.
        Always DYOR. Winky-launch detection will be added once the launch flow is live.
      </p>
    </section>
  </main>

<script>
  // ==============================
  // CONFIG
  // ==============================
  const WORKER_URL = "https://misty-king-27f4.christopher-milosch.workers.dev";
  const PAGE_SIZE  = 20;   // Birdeye limit
  const MAX_PAGES  = 5;    // bis zu 100 Tokens

  let currentPage  = 0;
  let isLoading    = false;

  let cachedTokens = [];
  const tokenMap   = new Map();  // key = address (oder fallback), value = token

  // ==============================
  // Helper
  // ==============================
  function formatUsd(num) {
    if (num == null || isNaN(num)) return "—";
    const n = Number(num);
    const abs = Math.abs(n);
    if (abs >= 1_000_000_000) return "$" + (n / 1_000_000_000).toFixed(1) + "B";
    if (abs >= 1_000_000)     return "$" + (n / 1_000_000).toFixed(1) + "M";
    if (abs >= 1_000)         return "$" + (n / 1_000).toFixed(1) + "K";
    if (abs >= 1)             return "$" + n.toFixed(3);
    return "$" + n.toFixed(6);
  }

  function formatChange(pct) {
    if (pct == null || isNaN(pct)) return "—";
    const v = Number(pct);
    const sign = v > 0 ? "+" : (v < 0 ? "" : "");
    return sign + v.toFixed(1) + "%";
  }

  function changeClass(pct) {
    if (pct == null || isNaN(pct)) return "change-flat";
    const v = Number(pct);
    if (v > 0.1)  return "change-pos";
    if (v < -0.1) return "change-neg";
    return "change-flat";
  }

  function computeRiskScore(marketCap, volume24h, liquidityUsd) {
    marketCap    = marketCap    || 0;
    volume24h    = volume24h    || 0;
    liquidityUsd = liquidityUsd || 0;

    // eher etablierte Coins → safe
    if (
      (marketCap >= 1_000_000_000 && liquidityUsd >= 1_000_000) ||
      (marketCap >= 300_000_000 && liquidityUsd >= 5_000_000 && volume24h >= 5_000_000) ||
      (liquidityUsd >= 25_000_000 && volume24h >= 25_000_000)
    ) {
      return 1;
    }

    // midcaps → medium
    if (
      (marketCap >= 20_000_000 && liquidityUsd >= 1_000_000 && volume24h >= 1_000_000) ||
      (marketCap >= 5_000_000 && liquidityUsd >= 300_000 && volume24h >= 300_000)
    ) {
      return 2;
    }

    // rest → high
    return 3;
  }

  function riskLabel(score) {
    if (score === 1) return "safe";
    if (score === 2) return "medium";
    return "high";
  }

  function riskClass(score) {
    if (score === 1) return "risk-safe";
    if (score === 2) return "risk-medium";
    return "risk-high";
  }

  // ==============================
  // Fetch von Worker
  // ==============================
  async function loadPage(pageIndex) {
    if (isLoading) return;
    if (pageIndex >= MAX_PAGES) return;

    const tbody       = document.getElementById("token-rows");
    const loadMoreBtn = document.getElementById("load-more-btn");

    isLoading = true;
    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = "Loading…";

    const offset = pageIndex * PAGE_SIZE;
    const url    = `${WORKER_URL}?limit=${PAGE_SIZE}&offset=${offset}`;
    console.log("Fetching page", pageIndex, "url:", url);

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Worker HTTP " + res.status);
      const json = await res.json();
      console.log("Worker response:", json);

      if (!json.success) throw new Error(json.message || "Worker success=false");

      const tokensArr =
        json.data &&
        json.data.data &&
        Array.isArray(json.data.data.tokens)
          ? json.data.data.tokens
          : [];

      if (!tokensArr.length && pageIndex === 0) {
        tbody.innerHTML =
          '<tr class="table-message-row"><td colspan="9">No tokens returned from Birdeye.</td></tr>';
        loadMoreBtn.style.display = "none";
        return;
      }

      if (!tokensArr.length) {
        loadMoreBtn.style.display = "none";
        return;
      }

      tokensArr.forEach((item) => {
        const name   = item.name   || "Unknown";
        const symbol = item.symbol || (name ? name.slice(0, 4).toUpperCase() : "?");
        const chain  = "solana";

        const address = item.address || "";
        const key = address || `${symbol}:${name}`;
        if (tokenMap.has(key)) return; // dedupe

        const imageUrl     = item.logoURI || null;
        const marketCap    = (item.marketcap != null ? item.marketcap : (item.fdv || 0));
        const volume24h    = item.volume24hUSD || 0;
        const liquidityUsd = item.liquidity || 0;
        const priceUsd     = item.price || 0;

        const change24h =
          item.price24hChangePercent ||
          item.priceChange24hPercent ||
          item.priceChange24h ||
          0;

        const riskScore = computeRiskScore(marketCap, volume24h, liquidityUsd);

        const dexUrl = address
          ? `https://birdeye.so/token/${address}?chain=${chain}`
          : "https://birdeye.so";

        const tokenObj = {
          name,
          symbol,
          chain,
          marketCap,
          volume24h,
          priceUsd,
          liquidityUsd,
          change24h,
          riskScore,
          riskLabel: riskLabel(riskScore),
          dexUrl,
          fromWinky: false,
          imageUrl,
          originalRank: typeof item.rank === "number" ? item.rank : 999999,
          address,
          key,
        };

        tokenMap.set(key, tokenObj);
      });

      cachedTokens = Array.from(tokenMap.values());
      applyFiltersAndRender();

      currentPage = pageIndex;

      if (currentPage >= MAX_PAGES - 1) {
        loadMoreBtn.style.display = "none";
      } else {
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = "Load more tokens";
      }
    } catch (err) {
      console.error("Birdeye load failed:", err);
      if (cachedTokens.length === 0) {
        tbody.innerHTML =
          '<tr class="table-message-row"><td colspan="9">Failed to load data from Birdeye. ' +
          (err && err.message ? err.message : "") +
          "</td></tr>";
      }
      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = "Load more tokens";
    } finally {
      isLoading = false;
    }
  }

  // ==============================
  // Render + Filter
  // ==============================
  function applyFiltersAndRender() {
    const tbody      = document.getElementById("token-rows");
    const search     = (document.getElementById("search").value || "").trim().toLowerCase();
    const riskFilter = document.getElementById("filter-risk").value;
    const mcapFilter = document.getElementById("filter-mcap").value;

    let list = cachedTokens.slice();

    if (search) {
      list = list.filter((t) =>
        t.name.toLowerCase().includes(search) ||
        t.symbol.toLowerCase().includes(search)
      );
    }

    if (riskFilter === "safe") {
      list = list.filter((t) => t.riskScore === 1);
    } else if (riskFilter === "medium") {
      list = list.filter((t) => t.riskScore === 2);
    } else if (riskFilter === "high") {
      list = list.filter((t) => t.riskScore === 3);
    }

    list = list.filter((t) => {
      const mc = t.marketCap || 0;
      if (mcapFilter === "small") return mc > 0 && mc < 1_000_000;
      if (mcapFilter === "mid")   return mc >= 1_000_000 && mc <= 10_000_000;
      if (mcapFilter === "large") return mc > 10_000_000;
      return true;
    });

    list.sort((a, b) => {
      if (a.riskScore !== b.riskScore) return a.riskScore - b.riskScore;
      return a.originalRank - b.originalRank;
    });

    if (!list.length) {
      tbody.innerHTML =
        '<tr class="table-message-row"><td colspan="9">No tokens match your filters right now.</td></tr>';
      return;
    }

    const rows = list.map((t) => {
      const logo = t.imageUrl
        ? `<div class="token-logo"><img src="${t.imageUrl}" alt=""></div>`
        : `<div class="token-logo">${(t.symbol || "?")[0]}</div>`;

      const fromWinky = t.fromWinky
        ? '<span class="from-winky-pill">WINKY LAUNCH</span>'
        : '<span class="token-symbol">—</span>';

      return `
        <tr>
          <td>
            <div class="token-cell">
              ${logo}
              <div>
                <div class="token-name">${t.name}</div>
                <div class="token-symbol">$${t.symbol}</div>
              </div>
            </div>
          </td>
          <td>${t.chain || "solana"}</td>
          <td class="number-cell">${formatUsd(t.priceUsd)}</td>
          <td class="number-cell">
            <span class="change-badge ${changeClass(t.change24h)}">
              ${formatChange(t.change24h)}
            </span>
          </td>
          <td class="number-cell">${formatUsd(t.marketCap)}</td>
          <td class="number-cell">${formatUsd(t.volume24h)}</td>
          <td>
            <span class="risk-badge ${riskClass(t.riskScore)}">
              ${t.riskLabel}
            </span>
          </td>
          <td>${fromWinky}</td>
          <td>
            <a class="btn-xs" href="${t.dexUrl}" target="_blank" rel="noreferrer">
              View on Birdeye
            </a>
          </td>
        </tr>
      `;
    });

    tbody.innerHTML = rows.join("");
  }

  // ==============================
  // Init
  // ==============================
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("search").addEventListener("input", applyFiltersAndRender);
    document.getElementById("filter-risk").addEventListener("change", applyFiltersAndRender);
    document.getElementById("filter-mcap").addEventListener("change", applyFiltersAndRender);

    const loadMoreBtn = document.getElementById("load-more-btn");
    loadMoreBtn.addEventListener("click", () => {
      const nextPage = currentPage + 1;
      if (nextPage < MAX_PAGES) {
        loadPage(nextPage);
      } else {
        loadMoreBtn.style.display = "none";
      }
    });

    // direkt erste Page laden
    loadPage(0);
  });
</script>

</body>
</html>
